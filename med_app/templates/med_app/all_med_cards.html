{% extends 'base.html' %}
{% load static %}

{% block title %}
{{ title|default:"Все мед. карты" }}
{% endblock title %}

{% block main %}
<div class="container-fluid mt-4 mb-4" style="max-width: 1100px;"></div>
    <h2 class="mb-4 text-center">Все медицинские карты</h2>
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="med-cards-table" class="table table-bordered table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 60px; min-width: 40px; max-width: 60px; text-align: center;">
                                №
                                <input type="text" id="filter-number" class="form-control form-control-sm mt-1 filter-input" placeholder="" style="width: 100%; min-width: 30px; max-width: 60px; text-align: center;">
                            </th>
                            <th scope="col">
                                ФИО
                                <input type="text" id="filter-fio" class="form-control form-control-sm mt-1 filter-input" placeholder="">
                            </th>
                            <th scope="col">
                                Дата рождения
                                <input type="text" id="filter-birth-date" class="form-control form-control-sm mt-1 filter-input" placeholder="">
                            </th>
                            <th scope="col">
                                Город
                                <input type="text" id="filter-city" class="form-control form-control-sm mt-1 filter-input" placeholder="">
                            </th>
                            <th scope="col">
                                Район
                                <input type="text" id="filter-district" class="form-control form-control-sm mt-1 filter-input" placeholder="">
                            </th>
                            <th scope="col" style="width: 80px; min-width: 60px; max-width: 90px; text-align: center;">
                                Действия
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med_card in med_cards %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>
                                {% if med_card.id %}
                                    <a href="{% url 'med_card_profile_url' med_card.id %}">
                                        {{ med_card.last_name }} {{ med_card.first_name }} {{ med_card.surname }}
                                    </a>
                                {% else %}
                                    {{ med_card.last_name }} {{ med_card.first_name }} {{ med_card.surname }}
                                {% endif %}
                            </td>
                            <td style="width: 100px;">{{ med_card.birth_date|date:"d.m.Y" }}</td>
                            <td style="width: 150px;">{{ med_card.city.name|default:"-" }}</td>
                            <td style="width: 150px;">{{ med_card.district.name|default:"-" }}</td>
                            <td class="text-center">
                                {% if med_card.id %}
                                <a href="{% url 'edit_med_card' med_card.id %}" class="btn btn-sm btn-primary" title="Редактировать">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Медицинские карты не найдены.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // Фильтрация таблицы медицинских карт
        function filterTable() {
            const filters = {
                number: document.getElementById('filter-number').value.toLowerCase(),
                fio: document.getElementById('filter-fio').value.toLowerCase(),
                birthDate: document.getElementById('filter-birth-date').value.toLowerCase(),
                city: document.getElementById('filter-city').value.toLowerCase(),
                district: document.getElementById('filter-district').value.toLowerCase()
            };

            const table = document.getElementById('med-cards-table');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length < 6) continue; // Skip empty rows

                const number = cells[0].textContent.toLowerCase();
                const fio = cells[1].textContent.toLowerCase();
                const birthDate = cells[2].textContent.toLowerCase();
                const city = cells[3].textContent.toLowerCase();
                const district = cells[4].textContent.toLowerCase();

                const showRow = (
                    number.includes(filters.number) &&
                    fio.includes(filters.fio) &&
                    birthDate.includes(filters.birthDate) &&
                    city.includes(filters.city) &&
                    district.includes(filters.district)
                );

                rows[i].style.display = showRow ? '' : 'none';
            }
        }

        // Добавить обработчики событий для фильтров
        const filterInputs = document.querySelectorAll('.filter-input');
        filterInputs.forEach(input => {
            input.addEventListener('input', filterTable);
        });
    </script>
</div>
{% endblock main %}

{% block scripts %}
{% include 'components/_scripts.html' %}
{% endblock scripts %}
