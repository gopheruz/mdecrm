{% extends 'base.html' %}
{% load static %}

{% block title %}
{{ title|default:"Все мед. карты" }}
{% endblock title %}

{% block main %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">{{ title|default:"Все медицинские карты" }}</h2>
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="med-cards-table" class="table table-bordered table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>№<input type="text" id="filter-number" class="form-control form-control-sm mt-1 filter-input" placeholder=""></th>
                            <th>ФИО<input type="text" id="filter-fio" class="form-control form-control-sm mt-1 filter-input" placeholder=""></th>
                            <th>Причина</th>
                            <th>Заметки</th>
                            <th>Дата рождения<input type="text" id="filter-birth-date" class="form-control form-control-sm mt-1 filter-input" placeholder=""></th>
                            <th>Город<input type="text" id="filter-city" class="form-control form-control-sm mt-1 filter-input" placeholder=""></th>
                            <th>Район<input type="text" id="filter-district" class="form-control form-control-sm mt-1 filter-input" placeholder=""></th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med_card in med_cards %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <a href="{% url 'med_card_profile_url' med_card.id %}">
                                    {{ med_card.last_name }} {{ med_card.first_name }} {{ med_card.surname }}
                                </a>
                            </td>
                            <td>{{ med_card.visits.first.reason|default:"-" }}</td>
                            <td>{{ med_card.visits.first.notes|default:"-" }}</td>
                            <td>{{ med_card.birth_date|date:"d.m.Y" }}</td>
                            <td>{{ med_card.city.name|default:"-" }}</td>
                            <td>{{ med_card.district.name|default:"-" }}</td>
                            <td class="text-center">
                                <a href="{% url 'edit_med_card' med_card.id %}" class="btn btn-outline-primary btn-sm px-2 py-1 rounded-circle shadow-sm" title="Редактировать">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">Медицинские карты не найдены.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function filterTable() {
        const filters = {
            number: document.getElementById('filter-number').value.toLowerCase(),
            fio: document.getElementById('filter-fio').value.toLowerCase(),
            birthDate: document.getElementById('filter-birth-date').value.toLowerCase(),
            city: document.getElementById('filter-city').value.toLowerCase(),
            district: document.getElementById('filter-district').value.toLowerCase()
        };

        const table = document.getElementById('med-cards-table');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            if (cells.length < 8) continue;

            const number = cells[0].textContent.toLowerCase();
            const fio = cells[1].textContent.toLowerCase();
            const birthDate = cells[4].textContent.toLowerCase();
            const city = cells[5].textContent.toLowerCase();
            const district = cells[6].textContent.toLowerCase();

            const showRow = (
                number.includes(filters.number) &&
                fio.includes(filters.fio) &&
                birthDate.includes(filters.birthDate) &&
                city.includes(filters.city) &&
                district.includes(filters.district)
            );

            rows[i].style.display = showRow ? '' : 'none';
        }
    }

    document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('input', filterTable);
    });
</script>

{% endblock main %}

{% block scripts %}
{% include 'components/_scripts.html' %}
{% endblock scripts %}
