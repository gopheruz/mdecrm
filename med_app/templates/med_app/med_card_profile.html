{% extends 'base.html' %}
{% load static %}

{% block title %}
{{ title|default:"Профиль медкарты" }}
{% endblock title %}

{% block main %}
<div class="container mt-4 mb-4">

    {# --- Секция Медицинской карты --- #}
    <div class="row mb-4">
        <div class="col-12"> {# Removed col-lg-10 col-xl-9 to match full width #}
            <div class="card shadow-sm border-light">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-person-fill me-2"></i>Медицинская карта
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        {# Фото #}
                        <div class="col-md-3 text-center mb-3 mb-md-0">
                            <img src="{% static 'med_app/images/123.webp' %}"
                                 alt="Фото пациента {{ med_card.last_name }}"
                                 class="img-thumbnail rounded-circle"
                                 width="140" height="140"
                                 style="object-fit: cover; border-width: 3px;"
                                 onerror="this.onerror=null; this.src='https://placehold.co/140x140/E0E0E0/B0B0B0?text=Фото';">
                        </div>

                        {# Данные в 2 колонки #}
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    {# Имя #}
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="bi bi-person-fill text-primary me-2 fs-5"></i>
                                        <div>
                                            <small class="text-muted d-block">Имя</small>
                                            <strong class="fs-6">{{ med_card.first_name|default:"-" }}</strong>
                                        </div>
                                    </div>
                                    {# Фамилия #}
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="bi bi-person-fill text-primary me-2 fs-5"></i>
                                        <div>
                                            <small class="text-muted d-block">Фамилия</small>
                                            <strong class="fs-6">{{ med_card.last_name|default:"-" }}</strong>
                                        </div>
                                    </div>
                                    {# Отчество #}
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-person-fill text-primary me-2 fs-5"></i>
                                        <div>
                                            <small class="text-muted d-block">Отчество</small>
                                            <strong class="fs-6">{{ med_card.surname|default:"-" }}</strong>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    {# Дата рождения #}
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="bi bi-calendar-event text-primary me-2 fs-5"></i>
                                        <div>
                                            <small class="text-muted d-block">Дата рождения</small>
                                            <strong class="fs-6">{{ med_card.birth_date|date:"d.m.Y"|default:"-" }}</strong>
                                        </div>
                                    </div>
                                    {# Город #}
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="bi bi-geo-alt-fill text-primary me-2 fs-5"></i>
                                        <div>
                                            <small class="text-muted d-block">Город</small>
                                            <strong class="fs-6">{{ med_card.city|default:"-" }}</strong>
                                        </div>
                                    </div>
                                    {# Район #}
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="bi bi-pin-map-fill text-primary me-2 fs-5"></i>
                                        <div>
                                            <small class="text-muted d-block">Район</small>
                                            <strong class="fs-6">{{ med_card.district|default:"-" }}</strong>
                                        </div>
                                    </div>
                                    {# Телефон #}
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-telephone-fill text-primary me-2 fs-5"></i>
                                        <div>
                                            <small class="text-muted d-block">Телефон</small>
                                            <strong class="fs-6">{{ med_card.phone_number|default:"-" }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{# --- Секция Истории посещений --- #}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-calendar-check-fill me-2"></i>История посещений</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">#ID</th>
                            <th scope="col">Дата/Время</th>
                            <th scope="col">Причина</th>
                            <th scope="col">Заметки</th>
                            <th scope="col">Зарегистрировал</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for visit in visits %}
                        <tr>
                            <th scope="row">{{ visit.id }}</th>
                            <td>{{ visit.visit_time|date:"d.m.Y H:i" }}</td>
                            <td>{{ visit.reason|default:"-" }}</td>
                            <td>{{ visit.notes|default:"-" }}</td>
                            <td>{{ visit.operator.get_full_name|default:visit.operator.username|default:"Не указан" }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center fst-italic text-muted py-3">
                                 <i class="bi bi-exclamation-circle me-2"></i>Посещений не найдено.
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {# --- Секция Истории звонков --- #}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-telephone-inbound-fill me-2"></i>История звонков</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Время звонка</th>
                            <th scope="col">IP Оператор</th>
                            <th scope="col">Аудио / Скачать</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for call in calls %}
                        <tr>
                            <th scope="row">{{ forloop.counter }}</th>
                            <td>{{ call.created_at|date:"d.m.Y H:i"|default:"-" }}</td>
                            <td>{{ call.operator|default:"Не указан" }}</td>
                            <td>
                                <div class="d-flex flex-column flex-sm-row gap-2 align-items-start">
                                    <audio controls class="mb-2 mb-sm-0">
                                        <source src="{% url 'stream_wav_file' call.wav_path %}" type="audio/wav">
                                        Ваш браузер не поддерживает аудио файлы.
                                    </audio>
                                    <a href="{% url 'download_wav_file' call.wav_path %}"
                                        class="btn btn-success btn-sm px-3" download="{{ wav_file.filename }}">
                                        <i class="bi bi-download me-1"></i>Скачать
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center fst-italic text-muted py-3">
                                <i class="bi bi-exclamation-circle me-2"></i>Звонков не найдено.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    

    {# --- Секция Кнопок Действий --- #}
    <div class="d-flex justify-content-center justify-content-md-end gap-3 mb-4">
         <a href="{% url 'create_user_call_get_or_post_url' med_card.id %}"
            class="btn btn-primary">
             <i class="bi bi-telephone-plus-fill me-1"></i>Добавить звонок
         </a>
         <a href="{% url 'create_visit_get_url' med_card.id %}"
            class="btn btn-success">
             <i class="bi bi-calendar-plus-fill me-1"></i>Добавить посещение
         </a>
    </div>

</div>

<style>
    .img-thumbnail {
        border: 2px solid #dee2e6;
        padding: 0.25rem;
    }
    .card {
        border-radius: 0.5rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audios = document.querySelectorAll('audio');
        audios.forEach(audio => {
            audio.addEventListener('play', function() {
                audios.forEach(otherAudio => {
                    if (otherAudio !== audio && !otherAudio.paused) {
                        otherAudio.pause();
                    }
                });
            });
        });
    });
</script>

{% endblock main %}